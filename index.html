<!DOCTYPE html>
<html>
<head>
  <title>Karate AI Shot Prediction</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 2rem;
    }
    #connect {
      padding: 1rem 2rem;
      font-size: 1.2rem;
    }
    #prediction {
      font-size: 2rem;
      font-weight: bold;
      margin-top: 2rem;
      color: #007bff;
    }
    #log {
      margin-top: 2rem;
      padding: 1rem;
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      height: 200px;
      overflow-y: auto;
      text-align: left;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1>Karate Shot Detector</h1>
  <button id="connect">Connect to BLE</button>
  <div id="prediction">No prediction yet</div>
  <div id="log"></div>

  <script>
    let bleDevice, bleCharacteristic;
    let bleBuffer = '';

    const logDiv = document.getElementById('log');
    const predictionDiv = document.getElementById('prediction');

    document.getElementById('connect').addEventListener('click', async () => {
      try {
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ services: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e'] }]
        });

        const server = await bleDevice.gatt.connect();
        const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
        bleCharacteristic = await service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');

        await bleCharacteristic.startNotifications();
        bleCharacteristic.addEventListener('characteristicvaluechanged', handleBluetoothData);

        logToConsole("✅ Connected and listening for data...");
      } catch (error) {
        console.error(error);
        logToConsole("❌ Connection failed: " + error);
      }
    });

    function handleBluetoothData(event) {
      const value = new TextDecoder().decode(event.target.value);
      bleBuffer += value;

      // Split on new lines
      const lines = bleBuffer.split('\n');
      bleBuffer = lines.pop(); // Save last incomplete line

      for (let line of lines) {
        line = line.trim();
        if (line.length === 0) continue;

        logToConsole(line); // Show full logs

        const prediction = extractPrediction(line);
        if (prediction) {
          predictionDiv.textContent = prediction.label;
          predictionDiv.style.color = "#28a745"; // green
        }
      }
    }

    function extractPrediction(line) {
      // Match one label per line
      const match = line.match(/(Idle|kisamiZuki|gyakuZuki):\s*([0-9.]+)/i);
      if (match) {
        const label = match[1];
        const confidence = parseFloat(match[2]);
        if (confidence > 0.6) {
          return { label, confidence };
        }
      }
      return null;
    }

    function logToConsole(text) {
      const logLine = document.createElement('div');
      logLine.textContent = text;
      logDiv.appendChild(logLine);
      logDiv.scrollTop = logDiv.scrollHeight; // Auto-scroll
    }
  </script>
</body>
</html>
